<!DOCTYPE html>
<html>
<head>
  <title>OCD Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 30px;
    }

    h1 {
      margin-bottom: 20px;
    }

    canvas {
      margin-top: 30px;
      margin-bottom: 50px;
    }

    pre {
      background: #f4f4f4;
      padding: 15px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <h1>Analytics Dashboard</h1>
  <h2> Sign Up </h2>
  <form id="signupForm">
	<label> Email: <input type="text" id="signupEmail" required></label><br><br>
	<label>Password: <input type="password" id="signupPassword" required></label><br><br>
	<button type="submit">Create Account</button>
	</form>
	<p id="signupMsg"></p>
  <h2>Log a New Event</h2>
  <form id="eventForm">
    <label>Trigger: <input type="text" id="trigger" required></label><br><br>
    <label>Compulsion: <input type="text" id="compulsion"></label><br><br>
    <label>Emotion: <input type="text" id="emotion"></label><br><br>
    <label>Notes: <textarea id="notes"></textarea></label><br><br>
    <button type="submit">Log Event</button>
  </form>
  <p id="submitMsg"></p>

  <canvas id="triggerChart" width="600" height="300"></canvas>
  <canvas id="dailyChart" width="600" height="300"></canvas>

  <pre id="data-output">Loading...</pre>

  <script>
   let triggerChart = null;
  let dailyChart = null;

  function loadAnalytics() {
    fetch('http://127.0.0.1:5000/analytics')
      .then(response => response.json())
      .then(data => renderDashboard(data))
      .catch(err => {
        console.error(err);
        document.getElementById('data-output').textContent = 'Error loading data';
      });
  }

  function renderDashboard(data) {
    document.getElementById('data-output').textContent =
      JSON.stringify(data, null, 2);

    const dates = data.dailyCounts.map(entry => entry.date);
    const counts = data.dailyCounts.map(entry => entry.count);
    const labels = Object.keys(data.topTriggers);
    const values = Object.values(data.topTriggers);

    if (triggerChart) triggerChart.destroy();
    if (dailyChart) dailyChart.destroy();

    const ctx2 = document.getElementById('dailyChart').getContext('2d');
    dailyChart = new Chart(ctx2, {
      type: 'line',
      data: {
        labels: dates,
        datasets: [{
          label: 'Entries per Day',
          data: counts,
          borderColor: 'rgba(54, 162, 235, 1)',
          fill: false
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });

    const ctx = document.getElementById('triggerChart').getContext('2d');
    triggerChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Trigger Frequency',
          data: values,
          backgroundColor: 'rgba(75, 192, 192, 0.7)'
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  // --- SIGNUP FORM ---
  document.getElementById('signupForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const email = document.getElementById('signupEmail').value;
    const password = document.getElementById('signupPassword').value;

    const payload = {
      email: email,
      passwordHash: password
    };

    try {
      const res = await fetch('http://127.0.0.1:5000/users', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        const data = await res.json();
        localStorage.setItem('user_id', data.id);
        document.getElementById('signupMsg').textContent = "Signup successful! Your ID is saved.";
      } else {
        document.getElementById('signupMsg').textContent = "Signup failed.";
      }
    } catch (err) {
      console.error(err);
      document.getElementById('signupMsg').textContent = "Network error.";
    }
  });

  // --- EVENT LOGGING FORM ---
  document.getElementById('eventForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const userId = localStorage.getItem('user_id');
    if (!userId) {
      document.getElementById('submitMsg').textContent = "No user ID found. Please sign up first.";
      return;
    }

    const trigger = document.getElementById('trigger').value;
    const compulsion = document.getElementById('compulsion').value;
    const emotion = document.getElementById('emotion').value;
    const notes = document.getElementById('notes').value;

    const payload = {
      user_id: userId,
      timestamp: new Date().toISOString(),
      trigger: trigger,
      compulsion: compulsion,
      emotion: emotion,
      notes: notes
    };

    try {
      const res = await fetch('http://127.0.0.1:5000/events', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        document.getElementById('submitMsg').textContent = "Event logged.";
        loadAnalytics();
      } else {
        document.getElementById('submitMsg').textContent = "Error logging event.";
      }
    } catch (err) {
      console.error(err);
      document.getElementById('submitMsg').textContent = "Network error.";
    }
  });

  loadAnalytics();
  </script>
</body>
</html>
