<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>OCD Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;max-width:960px;margin:32px auto;padding:0 16px}
    h1{margin:0 0 8px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;flex:1;min-width:280px}
    input,textarea,button,select{font:inherit;padding:8px;border:1px solid #bbb;border-radius:8px;width:100%}
    button{cursor:pointer}
    .ok{color:#0a7d28}
    .err{color:#a00}
    pre{white-space:pre-wrap;word-wrap:break-word;background:#fafafa;border:1px dashed #ddd;border-radius:8px;padding:8px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .muted{color:#666}
  </style>
</head>
<body>
  <h1>OCD Tracker</h1>
  <div class="muted" id="apiInfo"></div>
  <hr/>

  <div class="row">
    <div class="card" style="max-width:380px">
      <h3>Auth</h3>
      <div class="grid">
        <input id="email" type="email" placeholder="email@example.com"/>
        <input id="password" type="password" placeholder="password"/>
      </div>
      <div class="row" style="margin-top:8px">
        <button onclick="signup()">Sign Up</button>
        <button onclick="login()">Log In</button>
        <button onclick="logout()">Log Out</button>
      </div>
      <div id="authMsg" class="muted" style="margin-top:6px"></div>
      <div class="muted" style="margin-top:8px">User ID: <code id="uid">—</code></div>
    </div>

    <div class="card">
      <h3>Log Event</h3>
      <div class="grid">
        <input id="trigger" placeholder="Trigger (required)"/>
        <input id="compulsion" placeholder="Compulsion (optional)"/>
        <input id="emotion" placeholder="Emotion (optional)"/>
        <input id="ts" placeholder="Timestamp ISO (optional)"/>
      </div>
      <textarea id="notes" rows="4" placeholder="Notes (optional)"></textarea>
      <div class="row" style="margin-top:8px">
        <button onclick="createEvent()">Save Event</button>
        <button onclick="refreshAnalytics()">Refresh Analytics</button>
      </div>
      <div id="evtMsg" class="muted" style="margin-top:6px"></div>
    </div>
  </div>

  <div class="row" style="margin-top:16px">
    <div class="card">
      <h3>AI Sentiment</h3>
      <textarea id="aiNotes" rows="3" placeholder="Type something to analyze sentiment"></textarea>
      <div class="row" style="margin-top:8px">
        <button onclick="analyze()">Analyze</button>
      </div>
      <pre id="aiOut" class="muted" style="margin-top:6px"></pre>
    </div>

    <div class="card">
      <h3>Analytics</h3>
      <pre id="analytics" class="muted">—</pre>
      <div class="row">
        <button onclick="exportCsv()">Export CSV</button>
        <button onclick="exportPdf()">Export PDF</button>
      </div>
    </div>
  </div>

<script>
// Lock to deployed API to avoid localhost mixups
const API_BASE = "https://ocd-loop-tracker.onrender.com";
document.getElementById("apiInfo").textContent = `API: ${API_BASE}`;

function getUid(){ return localStorage.getItem("user_id") || ""; }
function setUid(v){ localStorage.setItem("user_id", v); document.getElementById("uid").textContent = v || "—"; }
setUid(getUid());

async function signup(){
  try{
    const r = await fetch(`${API_BASE}/users`, {method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({email: email.value, password: password.value})});
    const j = await r.json();
    if(!r.ok){ throw new Error(j.error||"signup failed"); }
    setUid(j.id);
    authMsg.innerHTML = `<span class="ok">Signup successful.</span>`;
  }catch(e){ authMsg.innerHTML = `<span class="err">${e}</span>`; }
}

async function login(){
  try{
    const r = await fetch(`${API_BASE}/login`, {method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({email: email.value, password: password.value})});
    const j = await r.json();
    if(!r.ok){ throw new Error(j.error||"login failed"); }
    setUid(j.id);
    authMsg.innerHTML = `<span class="ok">Login successful.</span>`;
  }catch(e){ authMsg.innerHTML = `<span class="err">${e}</span>`; }
}

function logout(){ setUid(""); authMsg.textContent="Logged out."; }

async function createEvent(){
  if(!getUid()){ evtMsg.innerHTML = `<span class="err">Log in first.</span>`; return; }
  try{
    const payload = {
      user_id: getUid(),
      trigger: trigger.value,
      compulsion: compulsion.value || null,
      emotion: emotion.value || null,
      notes: notes.value || null,
      timestamp: ts.value || new Date().toISOString()
    };
    const r = await fetch(`${API_BASE}/events`, {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload)});
    const j = await r.json();
    if(!r.ok){ throw new Error(j.error||"event failed"); }
    evtMsg.innerHTML = `<span class="ok">Event logged.</span>`;
    await refreshAnalytics();
  }catch(e){ evtMsg.innerHTML = `<span class="err">${e}</span>`; }
}

async function refreshAnalytics(){
  if(!getUid()){ analytics.textContent = "—"; return; }
  try{
    const r = await fetch(`${API_BASE}/analytics?user_id=${encodeURIComponent(getUid())}`);
    const j = await r.json();
    if(!r.ok){ throw new Error(j.error||"analytics failed"); }
    analytics.textContent = JSON.stringify(j, null, 2);
  }catch(e){ analytics.textContent = `error: ${e}`; }
}

async function analyze(){
  try{
    aiOut.textContent = "Analyzing…";
    const body = JSON.stringify({ notes: aiNotes.value });
    const headers = { "Content-Type": "application/json" };

    let j, ok=false, err="";
    for (let attempt=1; attempt<=3; attempt++){
      const r = await fetch(`${API_BASE}/analyze`, { method:"POST", headers, body });
      try { j = await r.json(); } catch(e){ j = {}; }
      if (r.ok && (j.available || ("label" in j))) { ok=true; break; }

      const reason = (j && j.reason || "").toLowerCase();
      if (reason.includes("503") || reason.includes("warm") || reason.includes("network") || reason.includes("429")){
        await new Promise(res => setTimeout(res, 800 * attempt));
        continue;
      }
      err = j && j.reason || `HTTP ${r.status}`;
      break;
    }

    if (ok){
      aiOut.textContent = `Label: ${j.label}  |  Score: ${Number(j.score ?? 0).toFixed(4)}`;
      localStorage.setItem("lastAnalysis", JSON.stringify({ ts: new Date().toISOString(), ...j }));
    }else{
      const last = (j && (j.reason || j.error)) || err || "unknown";
      aiOut.textContent = `AI analysis unavailable (${last}).`;
      console.log("Analyze debug payload:", j);
    }
  }catch(e){
    aiOut.textContent = `error: ${e}`;
  }
}

function exportCsv(){
  if(!getUid()) return;
  window.open(`${API_BASE}/export/csv?user_id=${encodeURIComponent(getUid())}`, "_blank");
}
function exportPdf(){
  if(!getUid()) return;
  window.open(`${API_BASE}/export/pdf?user_id=${encodeURIComponent(getUid())}`, "_blank");
}

refreshAnalytics();
</script>
</body>
</html>
