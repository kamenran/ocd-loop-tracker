<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>OCD Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    body{font-family:Segoe UI,Roboto,sans-serif;background:#f9fafc;color:#2C3E50;line-height:1.5;margin:0;padding:20px}
    .container{max-width:900px;margin:auto}
    header{text-align:center;margin-bottom:30px}
    h1{color:#1ABC9C;margin-bottom:8px}
    h2{color:#34495E;margin-top:0}
    .card{background:#fff;border-radius:10px;padding:20px;margin-bottom:20px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    label{display:block;margin:10px 0 5px;font-weight:500}
    input,textarea,button{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;margin-bottom:12px;box-sizing:border-box}
    textarea{resize:vertical}
    button{background:#1ABC9C;color:#fff;border:none;font-weight:bold;cursor:pointer;transition:background .2s}
    button:hover{background:#16a085}
    button:disabled{background:#95a5a6;cursor:not-allowed}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    p.msg{font-size:14px;margin-top:-8px;margin-bottom:10px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .pill{padding:6px 10px;border:1px solid #ddd;border-radius:999px;background:#fff}
    @media (max-width:600px){body{padding:15px}.actions{flex-direction:column}}
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>OCD Tracker</h1>
    <p>Your personal dashboard for tracking and reflection</p>
  </header>

  <!-- Mode + Backend status -->
  <div class="row" style="margin-bottom:12px">
    <div class="pill">
      Storage:
      <label><input type="radio" name="mode" value="local" checked> Local</label>
      <label><input type="radio" name="mode" value="cloud"> Cloud</label>
    </div>
    <div id="backendStatus" class="pill" style="display:none;color:#856404;background:#fff3cd;border-color:#ffeeba">Contacting server…</div>
  </div>

  <div class="card">
    <h2>Sign Up</h2>
    <form id="signupForm">
      <label>Email:</label>
      <input type="text" id="signupEmail" required>
      <label>Password:</label>
      <input type="password" id="signupPassword" required>
      <button type="submit">Create Account</button>
    </form>
    <p id="signupMsg" class="msg"></p>
  </div>

  <div class="card">
    <h2>Log In</h2>
    <form id="loginForm">
      <label>Email:</label>
      <input type="text" id="loginEmail" required>
      <label>Password:</label>
      <input type="password" id="loginPassword" required>
      <button type="submit">Log In</button>
    </form>
    <p id="loginMsg" class="msg"></p>
    <div class="actions">
      <button id="logoutBtn" style="display:none;">Log out</button>
      <button id="downloadCsvBtn" style="display:none;">Download CSV</button>
      <button id="downloadPdfBtn" style="display:none;">Download PDF</button>
    </div>
  </div>

  <div class="card">
    <h2>Log a New Event</h2>
    <form id="eventForm">
      <label>Trigger:</label>
      <input type="text" id="trigger" required>
      <label>Compulsion:</label>
      <input type="text" id="compulsion">
      <label>Emotion (optional):</label>
      <input type="text" id="emotion">
      <label>Notes:</label>
      <textarea id="notes"></textarea>
      <button type="submit">Log Event</button>
    </form>
    <p id="submitMsg" class="msg" aria-live="polite"></p>
  </div>

  <div class="card">
    <h2>Analytics</h2>
    <canvas id="triggerChart" height="300"></canvas>
    <canvas id="dailyChart" height="300"></canvas>
    <canvas id="emotionChart" height="300"></canvas>
    <pre id="data-output">Loading...</pre>
  </div>

  <footer><p>OCD Tracker • Built by Kamran Eisenberg</p></footer>
</div>

<script>
  // ---------------- Config
  const CLOUD_API_BASE = "https://ocd-tracker.ocdapp.workers.dev"; // <-- set this to your Worker URL
  const $status = document.getElementById('backendStatus');

  function getMode(){ return (document.querySelector('input[name="mode"]:checked')?.value)||"local"; }
  document.querySelectorAll('input[name="mode"]').forEach(r=>{
    r.addEventListener('change', ()=>{
      reflectAuthUI();
      loadAnalytics();
      if (getMode()==="cloud") checkBackend(); else $status.style.display='none';
    });
  });

  // ---------------- Backend status (Cloud mode)
  async function checkBackend(){
    $status.style.display='block'; $status.textContent="Contacting server…";
    try {
      const r = await fetch(`${CLOUD_API_BASE}/readyz`, { cache: 'no-store' });
      if (r.ok) { $status.style.color="#155724"; $status.style.background="#d4edda"; $status.textContent="Server ready"; setTimeout(()=> $status.style.display='none', 1200); }
      else { $status.textContent="Starting…"; }
    } catch { $status.textContent="Starting…"; }
  }

  // ---------------- Charts & UI state
  let triggerChart=null, dailyChart=null, emotionChart=null;

  function reflectAuthUI() {
    const uid = localStorage.getItem('user_id');
    const authed = !!uid;
    document.getElementById('signupForm').style.display = authed ? 'none' : 'block';
    document.getElementById('loginForm').style.display = authed ? 'none' : 'block';
    document.getElementById('eventForm').style.display = authed ? 'block' : 'none';
    document.getElementById('logoutBtn').style.display = authed ? 'inline-block' : 'none';
    document.getElementById('downloadCsvBtn').style.display = authed ? 'inline-block' : 'none';
    document.getElementById('downloadPdfBtn').style.display = authed ? 'inline-block' : 'none';
    if (!authed) document.getElementById('data-output').textContent = 'Please log in or sign up first.';
  }

  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('user_id');
    reflectAuthUI();
    document.getElementById('loginMsg').textContent = '';
    document.getElementById('signupMsg').textContent = '';
    document.getElementById('submitMsg').textContent = '';
  });

  // ------------- Storage abstraction (Local + Cloud)
  const store = {
    async signup(email, password){
      if (getMode()==="local") {
        const id = crypto.randomUUID();
        localStorage.setItem('user_'+email, JSON.stringify({id,email,passwordhash:password,created_at:new Date().toISOString()}));
        return {id};
      } else {
        const r = await fetch(`${CLOUD_API_BASE}/users`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email,password})});
        if (!r.ok) throw new Error(await r.text());
        return r.json();
      }
    },
    async login(email, password){
      if (getMode()==="local") {
        const raw = localStorage.getItem('user_'+email);
        if (!raw) throw new Error("User not found");
        const u = JSON.parse(raw);
        if (u.passwordhash !== password) throw new Error("Invalid password");
        return {id:u.id};
      } else {
        const r = await fetch(`${CLOUD_API_BASE}/login`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email,password})});
        if (!r.ok) throw new Error(await r.text());
        return r.json();
      }
    },
    async createEvent(ev){
      if (getMode()==="local") {
        const key = 'events_'+ev.user_id;
        const arr = JSON.parse(localStorage.getItem(key) || '[]');
        const id = crypto.randomUUID();
        arr.push({...ev, id});
        localStorage.setItem(key, JSON.stringify(arr));
        return {id};
      } else {
        const r = await fetch(`${CLOUD_API_BASE}/events`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(ev)});
        if (!r.ok) throw new Error(await r.text());
        return r.json();
      }
    },
    async listEvents(user_id){
      if (getMode()==="local") {
        const arr = JSON.parse(localStorage.getItem('events_'+user_id) || '[]');
        // Return without user_id field
        return arr.map(({id,trigger,compulsion,emotion,notes,timestamp,ai_emotion,ai_emotion_scores}) =>
          ({id,trigger,compulsion,emotion,notes,timestamp,ai_emotion,ai_emotion_scores})
        ).sort((a,b)=> (a.timestamp<b.timestamp?-1:1));
      } else {
        const r = await fetch(`${CLOUD_API_BASE}/events/list?user_id=${encodeURIComponent(user_id)}`);
        if (!r.ok) throw new Error(await r.text());
        const j = await r.json();
        return j.events || [];
      }
    },
    async analytics(user_id){
      if (getMode()==="local") {
        const arr = await this.listEvents(user_id);
        const topTriggers = {};
        const dailyMap = {};
        const emos = {};
        for (const e of arr){
          topTriggers[e.trigger] = (topTriggers[e.trigger]||0)+1;
          const d = (e.timestamp||"").slice(0,10);
          if (d) dailyMap[d] = (dailyMap[d]||0)+1;
          if (e.ai_emotion) emos[e.ai_emotion]=(emos[e.ai_emotion]||0)+1;
        }
        const dailyCounts = Object.entries(dailyMap).sort((a,b)=>a[0]<b[0]?-1:1).map(([date,count])=>({date,count}));
        return { topTriggers, dailyCounts, aiEmotions: emos };
      } else {
        const r = await fetch(`${CLOUD_API_BASE}/analytics?user_id=${encodeURIComponent(user_id)}`);
        if (!r.ok) throw new Error(await r.text());
        return r.json();
      }
    },
    async persistAIToEvent(id, ai){
      if (getMode()==="local") {
        // write into local record
        const uid = localStorage.getItem('user_id');
        const key = 'events_'+uid;
        const arr = JSON.parse(localStorage.getItem(key) || '[]');
        const i = arr.findIndex(e => e.id === id);
        if (i >= 0) { arr[i].ai_emotion = ai.label; arr[i].ai_emotion_scores = ai.scores; localStorage.setItem(key, JSON.stringify(arr)); }
        return {ok:true};
      } else {
        const r = await fetch(`${CLOUD_API_BASE}/events/ai`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ id, ai_emotion: ai.label, ai_emotion_scores: ai.scores })
        });
        if (!r.ok) throw new Error(await r.text());
        return r.json();
      }
    }
  };

  // Always-on AI (even in Local mode) — call Worker so HF key stays secret
  async function analyzeNotes(notes){
    const r = await fetch(`${CLOUD_API_BASE}/analyze`, {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ notes })
    });
    if (!r.ok) throw new Error("AI error");
    return r.json();
  }

  // ---------------- Analytics & Charts
  function renderDashboard(data) {
    document.getElementById('data-output').textContent = JSON.stringify(data, null, 2);
    const dates = data.dailyCounts.map(entry => entry.date);
    const counts = data.dailyCounts.map(entry => entry.count);
    const labels = Object.keys(data.topTriggers);
    const values = Object.values(data.topTriggers);

    if (triggerChart) triggerChart.destroy();
    if (dailyChart) dailyChart.destroy();
    if (emotionChart) emotionChart.destroy();

    const ctx2 = document.getElementById('dailyChart').getContext('2d');
    dailyChart = new Chart(ctx2, {
      type: 'line',
      data: { labels: dates, datasets: [{ label: 'Entries per Day', data: counts, borderColor: 'rgba(54,162,235,1)', fill: false }] },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    const ctx = document.getElementById('triggerChart').getContext('2d');
    triggerChart = new Chart(ctx, {
      type: 'bar',
      data: { labels: labels, datasets: [{ label: 'Trigger Frequency', data: values, backgroundColor: 'rgba(75,192,192,0.7)' }] },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    // Emotion chart
    const emoLabels = Object.keys(data.aiEmotions||{});
    const emoValues = Object.values(data.aiEmotions||{});
    const ectx = document.getElementById('emotionChart').getContext('2d');
    emotionChart = new Chart(ectx, {
      type: 'bar',
      data: { labels: emoLabels, datasets: [{ label: 'AI Emotions', data: emoValues, backgroundColor: 'rgba(255,159,64,0.7)' }] },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
  }

  async function loadAnalytics() {
    const userId = localStorage.getItem('user_id');
    if (!userId) {
      document.getElementById('data-output').textContent = 'Please log in or sign up first.';
      return;
    }
    try {
      const data = await store.analytics(userId);
      renderDashboard(data);
    } catch (e) {
      console.error(e);
      document.getElementById('data-output').textContent = 'Error loading data';
    }
  }

  // ---------------- CSV/PDF exports (no user_id)
  async function getExportRows() {
    const userId = localStorage.getItem('user_id');
    const rows = await store.listEvents(userId);
    // Strip user_id and keep columns we want
    return rows.map(r => ({
      id: r.id,
      trigger: r.trigger || "",
      compulsion: r.compulsion || "",
      emotion: r.emotion || "",
      notes: r.notes || "",
      timestamp: r.timestamp || "",
      ai_emotion: r.ai_emotion || ""
    }));
  }

  document.getElementById('downloadCsvBtn').addEventListener('click', async () => {
    const btn = document.getElementById('downloadCsvBtn');
    btn.disabled = true; const old = btn.textContent; btn.textContent = "Building…";
    try {
      const rows = await getExportRows();
      const header = ["id","trigger","compulsion","emotion","notes","timestamp","ai_emotion"];
      const csv = [header.join(",")].concat(rows.map(r=> header.map(h=> csvCell(r[h])).join(","))).join("\n");
      const blob = new Blob([csv], {type: "text/csv"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "events.csv";
      a.click();
    } finally { btn.disabled=false; btn.textContent=old; }
  });

  document.getElementById('downloadPdfBtn').addEventListener('click', async () => {
    const btn = document.getElementById('downloadPdfBtn');
    btn.disabled = true; const old = btn.textContent; btn.textContent = "Building…";
    try {
      const rows = await getExportRows();
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "pt", format: "letter" });
      doc.setFontSize(16); doc.text("OCD Tracker — Events Export", 40, 40);

      // simple table
      const header = ["id","trigger","compulsion","emotion","notes","timestamp","ai_emotion"];
      const colX = [40, 120, 220, 330, 410, 510, 600]; // rough columns
      doc.setFontSize(9);
      header.forEach((h,i)=> doc.text(h, colX[i], 70));

      let y = 90;
      const wrap = (t, max=34)=> (t||"").length<=max? [t||""] : (t||"").match(new RegExp(`.{1,${max}}`,'g'));
      rows.forEach(r => {
        const cells = header.map(h=> String(r[h]||""));
        // wrap notes
        const notesLines = wrap(cells[4], 40);
        const lines = Math.max(1, notesLines.length);
        for (let li=0; li<lines; li++){
          const vals = [
            li? "":cells[0],
            li? "":cells[1],
            li? "":cells[2],
            li? "":cells[3],
            notesLines[li] || "",
            li? "":cells[5],
            li? "":cells[6],
          ];
          vals.forEach((v,i)=> doc.text(String(v), colX[i], y));
          y += 14;
          if (y > 740) { doc.addPage(); y = 60; }
        }
        y += 6;
      });

      doc.save("events.pdf");
    } finally { btn.disabled=false; btn.textContent=old; }
  });

  function csvCell(v){ if (v==null) return ""; const s = String(v).replaceAll('"','""'); return `"${s}"`; }

  // ---------------- Forms
  document.getElementById('signupForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const email = document.getElementById('signupEmail').value;
    const password = document.getElementById('signupPassword').value;
    try {
      const r = await store.signup(email, password);
      localStorage.setItem('user_id', r.id);
      document.getElementById('signupMsg').textContent = "Signup successful!";
      reflectAuthUI(); loadAnalytics(); if (getMode()==="cloud") checkBackend();
    } catch (err) {
      document.getElementById('signupMsg').textContent = String(err);
    }
  });

  document.getElementById('loginForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    try {
      const r = await store.login(email, password);
      localStorage.setItem('user_id', r.id);
      document.getElementById('loginMsg').textContent = "Login successful!";
      reflectAuthUI(); loadAnalytics(); if (getMode()==="cloud") checkBackend();
    } catch (err) {
      document.getElementById('loginMsg').textContent = String(err);
    }
  });

  // Always analyze (AI not optional), even in Local mode
  document.getElementById('eventForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const userId = localStorage.getItem('user_id');
    const msgEl = document.getElementById('submitMsg');
    const btn = e.target.querySelector('button[type="submit"]');
    if (!userId) { msgEl.textContent = "Please log in first."; return; }

    const trigger = document.getElementById('trigger').value;
    const compulsion = document.getElementById('compulsion').value;
    const emotion = document.getElementById('emotion').value;
    const notes = document.getElementById('notes').value;

    const payload = { user_id: userId, timestamp: new Date().toISOString(), trigger, compulsion, emotion, notes };

    let dotsTimer=null;
    const startDots = (base="Analyzing")=>{
      let n=0; stopDots();
      dotsTimer=setInterval(()=>{ n=(n+1)%4; msgEl.textContent = base + ".".repeat(n); }, 400);
    };
    const stopDots = ()=> { if (dotsTimer){ clearInterval(dotsTimer); dotsTimer=null; } };

    try {
      btn.disabled=true; const old=btn.textContent; btn.textContent="Saving…"; msgEl.textContent="Saving event…";
      // 1) Save event (local or cloud)
      const saved = await store.createEvent(payload);
      // 2) Always run AI (even local mode)
      btn.textContent="Analyzing…"; startDots("Analyzing emotions");
      const ai = await analyzeNotes((notes||"").trim() || trigger || emotion || compulsion || "note");
      await store.persistAIToEvent(saved.id, ai);
      stopDots();
      const top3 = (ai.scores||[]).slice(0,3).map(s=>`${s.label} ${(s.score*100).toFixed(1)}%`).join(" • ");
      msgEl.textContent = `Event logged. AI emotions: ${top3}`;
      btn.textContent=old; btn.disabled=false;
      loadAnalytics();
    } catch (err) {
      stopDots();
      msgEl.textContent = "Error: " + String(err);
      btn.disabled=false; btn.textContent="Log Event";
    }
  });

  // ---------------- Init
  reflectAuthUI();
  if (getMode()==="cloud") checkBackend();
  if (localStorage.getItem('user_id')) loadAnalytics();
</script>
</body>
</html>
